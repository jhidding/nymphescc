<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding" />
  <title>NymphesCC</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #cccccc; background-color: #332244; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffcfaf; } /* Alert */
    code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #dca3a3; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #f0dfaf; } /* ControlFlow */
    code span.ch { color: #dca3a3; } /* Char */
    code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
    code span.co { color: #7f9f7f; } /* Comment */
    code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
    code span.do { color: #7f9f7f; } /* Documentation */
    code span.dt { color: #dfdfbf; } /* DataType */
    code span.dv { color: #dcdccc; } /* DecVal */
    code span.er { color: #c3bf9f; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #c0bed1; } /* Float */
    code span.fu { color: #efef8f; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
    code span.kw { color: #f0dfaf; } /* Keyword */
    code span.op { color: #f0efd0; } /* Operator */
    code span.ot { color: #efef8f; } /* Other */
    code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
    code span.sc { color: #dca3a3; } /* SpecialChar */
    code span.ss { color: #cc9393; } /* SpecialString */
    code span.st { color: #cc9393; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #cc9393; } /* VerbatimString */
    code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
  </style>
  <link rel="stylesheet" href="theme.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">NymphesCC</h1>
<p class="subtitle">MIDI controller using WxPython</p>
<p class="author">Johan Hidding</p>
</header>
<div class="row">
        <div class="col-6 col-s-9" id="main">
<div class="named-code-block">
<p>file:nymphescc/__init__.py</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>__version__ <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></span></code></pre></div>
</div>
<p><img src="fig/screenshot.png" alt="Screenshot" /></p>
<section id="core-data-model" class="level1">
<h1>Core data model</h1>
<p>At the core we have a bank with known values for each Midi CC. The
application should have an external MIDI In for 3rd party devices and a
duplex connection with the Nymphes. Messages from MIDI In should be
forwarded to the Nymphes, while messages from Nymphes should only affect
the internal state of NymphesCC.</p>
<div class="named-code-block">
<p>file:nymphescc/core.py</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> threading <span class="im">import</span> Event</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .messages <span class="im">import</span> read_settings, modulators, Setting, Group</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mido</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Iterator, Protocol</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BytesPort:</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">buffer</span><span class="op">=</span><span class="st">b&quot;&quot;</span>):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.selected_mod <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._file <span class="op">=</span> io.BytesIO(<span class="bu">buffer</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_input_port(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_output_port(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_cc(<span class="va">self</span>, channel: <span class="bu">int</span>, param: <span class="bu">int</span>, value: <span class="bu">int</span>):</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> mido.Message(<span class="st">&quot;control_change&quot;</span>, channel<span class="op">=</span>channel, control<span class="op">=</span>param, value<span class="op">=</span>value)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._file.write(msg.<span class="bu">bin</span>())</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">bytes</span>(<span class="va">self</span>):</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._file.getbuffer()</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_cc(<span class="va">self</span>, _) <span class="op">-&gt;</span> Iterator[<span class="bu">tuple</span>[<span class="bu">int</span>, <span class="bu">int</span>, <span class="bu">int</span>]]:</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> msg <span class="kw">in</span> mido.parse_all(<span class="va">self</span>.<span class="bu">bytes</span>):</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> msg.is_cc():</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> msg.channel, msg.control, msg.value</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> alsa_midi</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> alsa_midi <span class="im">import</span> WRITE_PORT, READ_PORT, PortCaps, PortType, ControlChangeEvent</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AlsaPort:</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, client, name, caps):</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.caps <span class="op">=</span> caps</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.selected_mod <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> client</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> caps:</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;in&quot;</span>:</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._port <span class="op">=</span> <span class="va">self</span>._client.create_port(name, WRITE_PORT, <span class="bu">type</span><span class="op">=</span>PortType.MIDI_GENERIC)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;out&quot;</span>:</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._port <span class="op">=</span> <span class="va">self</span>._client.create_port(name, READ_PORT, <span class="bu">type</span><span class="op">=</span>PortType.MIDI_GENERIC)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _:</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Unknown port caps &#39;</span><span class="sc">{</span>caps<span class="sc">}</span><span class="ss">&#39;&quot;</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> auto_connect(<span class="va">self</span>):</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.caps <span class="op">==</span> <span class="st">&quot;out&quot;</span>:</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>                ports <span class="op">=</span> <span class="va">self</span>._client.list_ports(output<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>                target <span class="op">=</span> <span class="bu">next</span>(p <span class="cf">for</span> p <span class="kw">in</span> ports <span class="cf">if</span> p.client_name <span class="op">==</span> <span class="st">&quot;Nymphes&quot;</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._port.connect_to(target)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.caps <span class="op">==</span> <span class="st">&quot;in&quot;</span>:</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>                ports <span class="op">=</span> <span class="va">self</span>._client.list_ports(<span class="bu">input</span><span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>                target <span class="op">=</span> <span class="bu">next</span>(p <span class="cf">for</span> p <span class="kw">in</span> ports <span class="cf">if</span> p.client_name <span class="op">==</span> <span class="st">&quot;Nymphes&quot;</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._port.connect_from(target)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">StopIteration</span>:</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            logging.warn(<span class="st">&quot;Nymphes device not found&quot;</span>)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> alsa_midi.ALSAError <span class="im">as</span> e:</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>            logging.error(e)</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>        logging.debug(<span class="st">&quot;connected to: </span><span class="sc">%s</span><span class="st">&quot;</span>, <span class="bu">str</span>(target))</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_cc(<span class="va">self</span>, channel: <span class="bu">int</span>, param: <span class="bu">int</span>, value: <span class="bu">int</span>):</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client.event_output(</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>            ControlChangeEvent(channel, param, value),</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>            port<span class="op">=</span><span class="va">self</span>._port)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client.drain_output()</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_cc(<span class="va">self</span>, quit_event: Event, timeout<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        port_id <span class="op">=</span> <span class="va">self</span>._port.get_info().port_id</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>            event <span class="op">=</span> <span class="va">self</span>._client.event_input(timeout<span class="op">=</span>timeout)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> event <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> quit_event.is_set():</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> event <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> event.dest.port_id <span class="op">==</span> port_id:</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(event, ControlChangeEvent):</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">yield</span> event.channel, event.param, event.value</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>                    logging.debug(<span class="st">&quot;skipped MIDI event: </span><span class="sc">%s</span><span class="st">&quot;</span>, <span class="bu">str</span>(event))</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Register:</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    flat_config: <span class="bu">dict</span>[<span class="bu">str</span>, Setting]</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    midi_map: <span class="bu">dict</span>[<span class="bu">int</span>, <span class="bu">tuple</span>[<span class="bu">str</span>, <span class="bu">str</span>]]</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    values: <span class="bu">dict</span>[<span class="bu">int</span>, <span class="bu">dict</span>[<span class="bu">str</span>, <span class="bu">int</span>]]</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gui_msg(<span class="va">self</span>, ctrl, mod, value):</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value <span class="op">!=</span> <span class="va">self</span>.values[mod][ctrl]:</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.values[mod][ctrl] <span class="op">=</span> value</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new():</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> read_settings()</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>        flat_config <span class="op">=</span> <span class="op">\</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>            { group.name <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> setting.name: setting</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> group <span class="kw">in</span> config.values()</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> setting <span class="kw">in</span> group.content }</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>        midi_map_global <span class="op">=</span> <span class="op">\</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>            { v.cc: (<span class="st">&quot;global&quot;</span>, k)</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> k, v <span class="kw">in</span> flat_config.items()</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> v.mod <span class="kw">is</span> <span class="va">None</span> }</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>        midi_map_baseline <span class="op">=</span> <span class="op">\</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>            { v.cc: (<span class="st">&quot;baseline&quot;</span>, k)</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> k, v <span class="kw">in</span> flat_config.items()</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> v.mod }</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>        midi_map_mod <span class="op">=</span> <span class="op">\</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>            { v.mod: (<span class="st">&quot;mod&quot;</span>, k)</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> k, v <span class="kw">in</span> flat_config.items()</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> v.mod }</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>        baseline_values <span class="op">=</span> { k: <span class="dv">0</span> <span class="cf">for</span> k <span class="kw">in</span> flat_config.keys() }</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> { mod: { k: <span class="dv">0</span> <span class="cf">for</span> k, v <span class="kw">in</span> flat_config.items() <span class="cf">if</span> v.mod <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>}</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">for</span> mod <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(modulators(config))) } <span class="op">\</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>               <span class="op">|</span> { <span class="dv">0</span>: baseline_values }</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>        values[<span class="dv">0</span>][<span class="st">&quot;misc.amp&quot;</span>] <span class="op">=</span> <span class="dv">127</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Register(</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>            flat_config,</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>            midi_map_global <span class="op">|</span> midi_map_baseline <span class="op">|</span> midi_map_mod,</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>            values)</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_cc(<span class="va">self</span>, port, ctrl, mod, value):</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mod <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> mod <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> port.selected_mod <span class="op">!=</span> mod:</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>                port.send_cc(<span class="dv">0</span>, <span class="va">self</span>.flat_config[<span class="st">&quot;modulators.selector&quot;</span>].cc, mod <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>                port.selected_mod <span class="op">=</span> mod</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>            port.send_cc(<span class="dv">0</span>, <span class="va">self</span>.flat_config[ctrl].mod, value)</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>            port.send_cc(<span class="dv">0</span>, <span class="va">self</span>.flat_config[ctrl].cc, value)</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_all(<span class="va">self</span>, port):</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> mod, s <span class="kw">in</span> <span class="va">self</span>.values.items():</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> ctrl, value <span class="kw">in</span> s.items():</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.send_cc(port, ctrl, mod, value)</span></code></pre></div>
</div>
<section id="reading-messages" class="level2">
<h2>Reading messages</h2>
<div class="named-code-block">
<p>file:nymphescc/messages.py</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> resources</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dhall</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, is_dataclass</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> typing</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Union</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> types</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConfigError(<span class="pp">Exception</span>):</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConfigValueError(ConfigError):</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    setting: Setting</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    what: <span class="bu">str</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConfigParserError(ConfigError):</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    input_str: <span class="bu">str</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    what: <span class="bu">str</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bounds:</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    lower: <span class="bu">int</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    upper: <span class="bu">int</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Tic:</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    value: <span class="bu">int</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    label: <span class="bu">str</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Setting:</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Setting class.</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Attributes:</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co">        name: name of the setting.</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="co">        long: human readable name.</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co">        cc: MIDI CC code</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co">        mod: MIDI CC code of modulator setting</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co">        bounds: lower (inclusive) and upper (exclusive) bounds</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="co">        tics: list of known values with description</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co">        labels: list of aliases for settings, should have same length</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co">            as bounds interval.</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">        flags: list of related settings.</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">long</span>: <span class="bu">str</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    cc: <span class="bu">int</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    bounds: Bounds</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    description: Optional[<span class="bu">str</span>]</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    mod: Optional[<span class="bu">int</span>]</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    tics: Optional[<span class="bu">list</span>[Tic]]</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    labels: Optional[<span class="bu">list</span>[<span class="bu">str</span>]]</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate(<span class="va">self</span>):</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> (<span class="va">self</span>.bounds.lower <span class="op">&lt;</span> <span class="va">self</span>.bounds.upper):</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> ConfigValueError(<span class="va">self</span>, <span class="st">&quot;illegal bounds&quot;</span>)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.labels <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="op">\</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> <span class="bu">len</span>(<span class="va">self</span>.labels) <span class="op">!=</span> (<span class="va">self</span>.bounds.upper <span class="op">-</span> <span class="va">self</span>.bounds.lower <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> ConfigValueError(<span class="va">self</span>, <span class="st">&quot;wrong number of labels&quot;</span>)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_scale(<span class="va">self</span>):</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.bounds.lower <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>.bounds.upper <span class="op">==</span> <span class="dv">127</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_enum(<span class="va">self</span>):</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.labels <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Group:</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">long</span>: <span class="bu">str</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    description: Optional[<span class="bu">str</span>]</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    content: <span class="bu">list</span>[Setting]</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scales(<span class="va">self</span>):</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">filter</span>(Setting.is_scale, <span class="va">self</span>.content))</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> enums(<span class="va">self</span>):</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">filter</span>(Setting.is_enum, <span class="va">self</span>.content))</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> isgeneric(annot):</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">hasattr</span>(annot, <span class="st">&quot;__origin__&quot;</span>) <span class="op">\</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> <span class="bu">hasattr</span>(annot, <span class="st">&quot;__args__&quot;</span>)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct(annot, json):</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Construct an object from a given type from a JSON stream.</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="co">    The `annot` type should be one of: str, int, list[T], Optional[T],</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a><span class="co">    or a dataclass, and the JSON data should match exactly the given</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="co">    definitions in the dataclass hierarchy.</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> annot <span class="kw">is</span> <span class="bu">str</span>:</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">isinstance</span>(json, <span class="bu">str</span>)</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> annot <span class="kw">is</span> <span class="bu">int</span>:</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">isinstance</span>(json, <span class="bu">int</span>)</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> isgeneric(annot) <span class="kw">and</span> typing.get_origin(annot) <span class="kw">is</span> <span class="bu">list</span>:</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">isinstance</span>(json, <span class="bu">list</span>)</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [construct(typing.get_args(annot)[<span class="dv">0</span>], item) <span class="cf">for</span> item <span class="kw">in</span> json]</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> isgeneric(annot) <span class="kw">and</span> typing.get_origin(annot) <span class="kw">is</span> Union <span class="op">\</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> typing.get_args(annot)[<span class="dv">1</span>] <span class="kw">is</span> types.NoneType:</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> json <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> construct(typing.get_args(annot)[<span class="dv">0</span>], json)</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_dataclass(annot):</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">isinstance</span>(json, <span class="bu">dict</span>)</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>        arg_annot <span class="op">=</span> typing.get_type_hints(annot)</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">all</span>(k <span class="kw">in</span> json <span class="cf">for</span> k <span class="kw">in</span> arg_annot)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        args <span class="op">=</span> { k: construct(v, json[k])</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">for</span> k, v <span class="kw">in</span> arg_annot.items() }</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> annot(<span class="op">**</span>args)</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_settings():</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> resources.open_text(__package__, <span class="st">&quot;messages.dhall&quot;</span>) <span class="im">as</span> inp:</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        raw_data <span class="op">=</span> dhall.load(inp)</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>    group_lst <span class="op">=</span> construct(<span class="bu">list</span>[Group], raw_data)</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { grp.name: grp <span class="cf">for</span> grp <span class="kw">in</span> group_lst }</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> modulators(settings):</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> settings[<span class="st">&quot;modulators&quot;</span>].content[<span class="dv">0</span>].labels</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">&quot;Baseline&quot;</span>] <span class="op">+</span> labels</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(read_settings())</span></code></pre></div>
</div>
</section>
</section>
<section id="gui" class="level1">
<h1>GUI</h1>
<p>The GUI is using Gtk 4.0.</p>
<div class="named-code-block">
<p>file:nymphescc/gtk.py</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> queue</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> queue <span class="im">import</span> Queue</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> threading <span class="im">import</span> Thread</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> resources</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> OrderedDict</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> functools</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gi</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>gi.require_version(<span class="st">&quot;Gtk&quot;</span>, <span class="st">&quot;4.0&quot;</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gi.repository <span class="im">import</span> GObject, Gtk, GLib, Gdk, Gio</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> alsa_midi <span class="im">import</span> SequencerClient</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .messages <span class="im">import</span> read_settings, Group, modulators</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .core <span class="im">import</span> Register, AlsaPort, BytesPort</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .db <span class="im">import</span> NymphesDB</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Interface:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.q_out <span class="op">=</span> Queue()</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.set_ui_value <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.register <span class="op">=</span> Register.new()</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> SequencerClient(<span class="st">&quot;NymphesCC&quot;</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nymphes_in_port <span class="op">=</span> AlsaPort(client, <span class="st">&quot;device-in&quot;</span>, <span class="st">&quot;in&quot;</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nymphes_out_port <span class="op">=</span> AlsaPort(client, <span class="st">&quot;device-out&quot;</span>, <span class="st">&quot;out&quot;</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.through_port <span class="op">=</span> AlsaPort(client, <span class="st">&quot;through&quot;</span>, <span class="st">&quot;in&quot;</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.quit_event <span class="op">=</span> threading.Event()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db <span class="op">=</span> NymphesDB()</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nymphes_in_port.auto_connect()</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nymphes_out_port.auto_connect()</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_ui(<span class="va">self</span>, ctrl, mod, value):</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        GLib.idle_add(<span class="va">self</span>.set_ui_value, ctrl, mod, value)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_nymphes(<span class="va">self</span>):</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>                ctrl, mod, value <span class="op">=</span> <span class="va">self</span>.q_out.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> queue.Empty:</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.quit_event.is_set():</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mod <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> mod <span class="op">!=</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>.nymphes_out_port.selected_mod <span class="op">!=</span> mod:</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.nymphes_out_port.send_cc(</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">0</span>, <span class="va">self</span>.register.flat_config[<span class="st">&quot;modulators.selector&quot;</span>].cc, mod <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.nymphes_out_port.selected_mod <span class="op">=</span> mod</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mod <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> mod <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.nymphes_out_port.send_cc(</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">0</span>, <span class="va">self</span>.register.flat_config[ctrl].mod, value)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.nymphes_out_port.send_cc(</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">0</span>, <span class="va">self</span>.register.flat_config[ctrl].cc, value)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.q_out.task_done()</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_port(<span class="va">self</span>, port, forward<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> chan, param, value <span class="kw">in</span> port.read_cc(<span class="va">self</span>.quit_event):</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> forward:</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.nymphes_out_port.send_cc(chan, param, value)</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> param <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.register.midi_map:</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>                logging.warn(<span class="st">&quot;msg </span><span class="sc">%u</span><span class="st"> </span><span class="sc">%u</span><span class="st"> </span><span class="sc">%u</span><span class="st"> unknown&quot;</span>, chan, param, value)</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            kind, ctrl <span class="op">=</span> <span class="va">self</span>.register.midi_map[param]</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>            logging.debug(<span class="st">&quot;msg </span><span class="sc">%u</span><span class="st"> </span><span class="sc">%u</span><span class="st"> </span><span class="sc">%u</span><span class="st">, read as </span><span class="sc">%s</span><span class="st">:</span><span class="sc">%s</span><span class="st">&quot;</span>, chan, param, value, kind, ctrl)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> kind <span class="op">==</span> <span class="st">&quot;mod&quot;</span>:</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.register.values[port.selected_mod][ctrl] <span class="op">=</span> value</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.set_ui(ctrl, port.selected_mod, value)</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> ctrl <span class="op">==</span> <span class="st">&quot;modulators.selector&quot;</span>:</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>                port.selected_mod <span class="op">=</span> value <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.register.values[<span class="dv">0</span>][ctrl] <span class="op">=</span> value</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.set_ui(ctrl, <span class="dv">0</span>, value)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_nymphes(<span class="va">self</span>):</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.read_port(<span class="va">self</span>.nymphes_in_port, forward<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_snapshot(<span class="va">self</span>, snap_id):</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        midi <span class="op">=</span> <span class="va">self</span>.db.snapshot(snap_id).midi</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        port <span class="op">=</span> BytesPort(midi)</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.read_port(port, forward<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_midi(<span class="va">self</span>):</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        port <span class="op">=</span> BytesPort()</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.register.send_all(port)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> port.<span class="bu">bytes</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> slider_group(group: Group, on_changed):</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    sliders <span class="op">=</span> {}</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    combos <span class="op">=</span> {}</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> Gtk.Frame()</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    frame.set_label(group.<span class="bu">long</span>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> Gtk.Grid()</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    grid.set_column_spacing(<span class="dv">6</span>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    grid.set_margin_bottom(<span class="dv">5</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    grid.set_column_homogeneous(<span class="va">True</span>)</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    frame.set_child(grid)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, s <span class="kw">in</span> <span class="bu">enumerate</span>(group.scales):</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>        slider <span class="op">=</span> Gtk.Scale.new_with_range(Gtk.Orientation.VERTICAL, s.bounds.lower, s.bounds.upper, <span class="dv">1</span>)</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        slider.set_vexpand(<span class="va">True</span>)</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>        slider.set_draw_value(<span class="va">True</span>)</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        slider.set_inverted(<span class="va">True</span>)</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>        slider.set_value_pos(Gtk.PositionType.BOTTOM)</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s.mod <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>            slider.add_css_class(<span class="st">&quot;mod&quot;</span>)</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if not s.tics:</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>        slider.add_mark(<span class="dv">0</span>, Gtk.PositionType.LEFT, <span class="va">None</span>)</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>        slider.add_mark(<span class="dv">63</span>, Gtk.PositionType.LEFT, <span class="va">None</span>)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        slider.add_mark(<span class="dv">127</span>, Gtk.PositionType.LEFT, <span class="va">None</span>)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># else:</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>        <span class="co">#    for t in s.tics:</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>        <span class="co">#        slider.add_mark(t.value, Gtk.PositionType.LEFT, t.label)</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> Gtk.Label()</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>        label.set_label(s.name.upper())</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>        grid.attach(slider, i, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        grid.attach(label, i, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>        qname <span class="op">=</span> group.name <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> s.name</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>        slider.<span class="ex">connect</span>(<span class="st">&quot;value-changed&quot;</span>, on_changed, qname)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>        sliders[qname] <span class="op">=</span> slider</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, s <span class="kw">in</span> <span class="bu">enumerate</span>(group.enums):</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>        combo <span class="op">=</span> Gtk.ComboBoxText()</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>        combo.set_margin_end(<span class="dv">5</span>)</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> s.labels:</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>            combo.append(<span class="va">None</span>, t)</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> Gtk.Label.new(s.name.upper())</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>            combo.set_margin_top(<span class="dv">5</span>)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        grid.attach(label, <span class="dv">0</span>, i<span class="op">+</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        grid.attach(combo, <span class="dv">1</span>, i<span class="op">+</span><span class="dv">2</span>, <span class="bu">len</span>(group.scales) <span class="op">-</span> <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>        qname <span class="op">=</span> group.name <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> s.name</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>        combo.<span class="ex">connect</span>(<span class="st">&quot;changed&quot;</span>, on_changed, qname)</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>        combos[qname] <span class="op">=</span> combo</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame, sliders <span class="op">|</span> combos</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> list_box_label(name: <span class="bu">str</span>):</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> Gtk.Label()</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>    label.set_label(name)</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>    label.set_name(name.lower().replace(<span class="st">&quot; &quot;</span>, <span class="st">&quot;-&quot;</span>))</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>    label.set_margin_top(<span class="dv">5</span>)</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    label.set_margin_bottom(<span class="dv">5</span>)</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> label</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> list_box_setting(items: <span class="bu">list</span>[<span class="bu">str</span>]):</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>    list_box <span class="op">=</span> Gtk.ListBox()</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> items:</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>        list_box.append(list_box_label(name))</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>    list_box.set_hexpand(<span class="va">True</span>)</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>    list_box.set_selection_mode(Gtk.SelectionMode.BROWSE)</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>    list_box.set_vexpand(<span class="va">True</span>)</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> list_box</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_selector(settings: <span class="bu">dict</span>[<span class="bu">str</span>, Group]):</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>    vbox <span class="op">=</span> Gtk.Box.new(Gtk.Orientation.VERTICAL, <span class="dv">5</span>)</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>    mod_group <span class="op">=</span> settings[<span class="st">&quot;modulators&quot;</span>]</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>    play_group <span class="op">=</span> settings[<span class="st">&quot;misc&quot;</span>]</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> Gtk.Frame()</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>    frame.set_label(mod_group.<span class="bu">long</span>)</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>    setting <span class="op">=</span> mod_group.content[<span class="dv">0</span>]</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>    list_box_mod <span class="op">=</span> list_box_setting(modulators(settings))</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>    list_box_mod.select_row(list_box_mod.get_row_at_index(<span class="dv">0</span>))</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>    list_box_mod.add_css_class(<span class="st">&quot;mod&quot;</span>)</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>    frame.set_child(list_box_mod)</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>    vbox.append(frame)</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> Gtk.Frame()</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>    setting <span class="op">=</span> <span class="bu">next</span>(s <span class="cf">for</span> s <span class="kw">in</span> play_group.content <span class="cf">if</span> s.name <span class="op">==</span> <span class="st">&quot;mode&quot;</span>)</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>    frame.set_label(setting.<span class="bu">long</span>)</span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>    list_box_play <span class="op">=</span> list_box_setting(setting.labels <span class="kw">or</span> [])</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>    frame.set_child(list_box_play)</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>    vbox.append(frame)</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vbox, { <span class="st">&quot;modulators.selector&quot;</span>: list_box_mod</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>                 , <span class="st">&quot;misc.mode&quot;</span>: list_box_play }</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> icon_button(icon_name: <span class="bu">str</span>) <span class="op">-&gt;</span> Gtk.Button:</span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>    button <span class="op">=</span> Gtk.Button()</span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>    button.set_icon_name(icon_name)</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> button</span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tool_bar(<span class="op">**</span>icon_names) <span class="op">-&gt;</span> <span class="bu">tuple</span>[Gtk.Box, <span class="bu">dict</span>[<span class="bu">str</span>, Gtk.Button]]:</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>    box <span class="op">=</span> Gtk.Box()</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>    buttons <span class="op">=</span> OrderedDict((k, icon_button(v)) <span class="cf">for</span> k, v <span class="kw">in</span> icon_names.items())</span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> button <span class="kw">in</span> buttons.values():</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>        button.set_has_frame(<span class="va">False</span>)</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>        box.append(button)</span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> box, buttons</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GGroupInfo(GObject.GObject):</span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> GObject.<span class="bu">property</span>(<span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> GObject.<span class="bu">property</span>(<span class="bu">type</span><span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>    description <span class="op">=</span> GObject.<span class="bu">property</span>(<span class="bu">type</span><span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(GGroupInfo, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new(key: <span class="bu">int</span>, name: <span class="bu">str</span>, description: <span class="bu">str</span>) <span class="op">-&gt;</span> GGroupInfo:</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> GGroupInfo()</span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>        obj.key <span class="op">=</span> key</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>        obj.name <span class="op">=</span> name</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>        obj.description <span class="op">=</span> description</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj</span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GSnapshotInfo(GObject.GObject):</span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> GObject.<span class="bu">property</span>(<span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> GObject.<span class="bu">property</span>(<span class="bu">type</span><span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(GSnapshotInfo, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new(key: <span class="bu">int</span>, timestamp: <span class="bu">float</span>) <span class="op">-&gt;</span> GSnapshotInfo:</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> GSnapshotInfo()</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>        obj.key <span class="op">=</span> key</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>        obj.timestamp <span class="op">=</span> timestamp</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj</span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DeletableRow(Gtk.Box):</span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(DeletableRow, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new(text: <span class="bu">str</span>):</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>        box <span class="op">=</span> DeletableRow()</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>        box._label <span class="op">=</span> Gtk.Label.new(text)</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>        box._label.set_hexpand(<span class="va">True</span>)</span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>        box._label.set_justify(Gtk.Justification.LEFT)</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>        box._label.set_halign(Gtk.Align.START)</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>        box._label.set_margin_top(<span class="dv">10</span>)</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>        box._label.set_margin_bottom(<span class="dv">10</span>)</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>        box._label.set_margin_start(<span class="dv">5</span>)</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>        box.append(box._label)</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>        box._delete_button <span class="op">=</span> icon_button(<span class="st">&quot;edit-delete-symbolic&quot;</span>)</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>        box._delete_button.set_has_frame(<span class="va">False</span>)</span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>        box.append(box._delete_button)</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>        box.hide_delete_button()</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> box</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> show_delete_button(<span class="va">self</span>):</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._delete_button.set_visible(<span class="va">True</span>)</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hide_delete_button(<span class="va">self</span>):</span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._delete_button.set_visible(<span class="va">False</span>)</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_label(<span class="va">self</span>, text: <span class="bu">str</span>):</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._label.set_label(text)</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> delete_button(<span class="va">self</span>):</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._delete_button</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maybe(f):</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">@functools.wraps</span>(f)</span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> maybe_f(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> f(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">AttributeError</span>:</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> maybe_f</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SessionPane:</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>    iface: Interface</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>    search_entry: Gtk.SearchEntry</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>    session_list: Gtk.ListBox</span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>    add_session_button: Gtk.Button</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>    info_box: Gtk.Box</span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>    name: Gtk.Entry</span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>    description: Gtk.TextView</span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>    snapshot_list: Gtk.ListBox</span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>    add_snapshot_button: Gtk.Button</span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>    session_list_store: Gio.ListStore <span class="op">\</span></span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>        <span class="op">=</span> field(default_factory<span class="op">=</span><span class="kw">lambda</span>: Gio.ListStore.new(GGroupInfo))</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>    snapshot_list_store: Gio.ListStore <span class="op">\</span></span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>        <span class="op">=</span> field(default_factory<span class="op">=</span><span class="kw">lambda</span>: Gio.ListStore.new(GSnapshotInfo))</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __post_init__(<span class="va">self</span>):</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list.bind_model(<span class="va">self</span>.session_list_store, <span class="va">self</span>.session_list_row)</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.snapshot_list.bind_model(<span class="va">self</span>.snapshot_list_store, <span class="va">self</span>.snapshot_list_row)</span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list.<span class="ex">connect</span>(<span class="st">&quot;row-selected&quot;</span>, <span class="va">self</span>.select_group_event)</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.snapshot_list.<span class="ex">connect</span>(<span class="st">&quot;row-selected&quot;</span>, <span class="va">self</span>.select_snapshot_event)</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_session_button.<span class="ex">connect</span>(<span class="st">&quot;clicked&quot;</span>, <span class="va">self</span>.add_session_event)</span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_snapshot_button.<span class="ex">connect</span>(<span class="st">&quot;clicked&quot;</span>, <span class="va">self</span>.add_snapshot_event)</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name.<span class="ex">connect</span>(<span class="st">&quot;changed&quot;</span>, <span class="va">self</span>.name_changed_event)</span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.description.get_buffer().<span class="ex">connect</span>(<span class="st">&quot;changed&quot;</span>, <span class="va">self</span>.description_changed_event)</span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name.<span class="ex">connect</span>(<span class="st">&quot;editing-done&quot;</span>, <span class="va">self</span>.focus_description)</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.load_groups()</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._selected_row <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">@maybe</span></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> group_id(<span class="va">self</span>):</span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> <span class="va">self</span>.session_list.get_selected_row().get_index()</span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.session_list_store.get_item(idx).key</span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">@maybe</span></span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> group_info(<span class="va">self</span>):</span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> <span class="va">self</span>.session_list.get_selected_row().get_index()</span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.session_list_store.get_item(idx)</span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">@maybe</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> snapshot_id(<span class="va">self</span>):</span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> <span class="va">self</span>.snapshot_list.get_selected_row().get_index()</span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.snapshot_list_store.get_item(idx).key</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> session_list_row(<span class="va">self</span>, group_info: GGroupInfo) <span class="op">-&gt;</span> DeletableRow:</span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> DeletableRow.new(group_info.name)</span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>        x.delete_button.<span class="ex">connect</span>(<span class="st">&quot;clicked&quot;</span>, <span class="va">self</span>.delete_session)</span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> focus_description(<span class="va">self</span>, _):</span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.description.grab_focus()</span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> delete_session(<span class="va">self</span>, _):</span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> <span class="va">self</span>.session_list.get_selected_row().get_index()</span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iface.db.delete_group(<span class="va">self</span>.group_id())</span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._selected_row <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list_store.remove(idx)</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> snapshot_list_row(<span class="va">self</span>, snapshot_info: GSnapshotInfo) <span class="op">-&gt;</span> Gtk.Label:</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Gtk.Label.new(datetime.fromtimestamp(snapshot_info.timestamp).strftime(<span class="st">&quot;</span><span class="sc">%c</span><span class="st">&quot;</span>))</span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_groups(<span class="va">self</span>):</span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list_store.remove_all()</span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> g <span class="kw">in</span> <span class="va">self</span>.iface.db.groups():</span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.session_list_store.append(GGroupInfo.new(g.key, g.name, g.description))</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_snapshots(<span class="va">self</span>, group_id):</span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.snapshot_list_store.remove_all()</span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> s <span class="kw">in</span> <span class="va">self</span>.iface.db.snapshots(group_id):</span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.snapshot_list_store.append(GSnapshotInfo.new(s.key, s.timestamp.timestamp()))</span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> select_group_event(<span class="va">self</span>, _1, row):</span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.info_box.set_sensitive(<span class="va">False</span>)</span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.name.set_text(<span class="st">&quot;&quot;</span>)</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.description.get_buffer().set_text(<span class="st">&quot;&quot;</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.snapshot_list_store.remove_all()</span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>        row.get_child().show_delete_button()</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._selected_row:</span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._selected_row.get_child().hide_delete_button()</span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._selected_row <span class="op">=</span> row</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>        info <span class="op">=</span> <span class="va">self</span>.iface.db.group_info(<span class="va">self</span>.group_id())</span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.info_box.set_sensitive(<span class="va">True</span>)</span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name.set_text(info.name)</span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.description.get_buffer().set_text(info.description <span class="kw">or</span> <span class="st">&quot;&quot;</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.load_snapshots(info.key)</span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> select_snapshot_event(<span class="va">self</span>, _1, _2):</span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.snapshot_id() <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iface.load_snapshot(<span class="va">self</span>.snapshot_id())</span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_session_event(<span class="va">self</span>, _):</span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>        group_id <span class="op">=</span> <span class="va">self</span>.iface.db.new_group(<span class="st">&quot;New Group&quot;</span>)</span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>        info <span class="op">=</span> <span class="va">self</span>.iface.db.group_info(group_id)</span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list_store.append(GGroupInfo.new(info.key, info.name, info.description))</span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> <span class="va">self</span>.session_list_store.get_n_items() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list.select_row(<span class="va">self</span>.session_list.get_row_at_index(idx))</span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name.select_region(<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name.grab_focus()</span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_snapshot_event(<span class="va">self</span>, _):</span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>        snap_id <span class="op">=</span> <span class="va">self</span>.iface.db.new_snapshot(<span class="va">self</span>.group_info().key, <span class="va">self</span>.iface.get_midi())</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> <span class="va">self</span>.iface.db.snapshot(snap_id)</span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.snapshot_list_store.append(GSnapshotInfo.new(s.key, s.timestamp.timestamp()))</span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> <span class="va">self</span>.snapshot_list_store.get_n_items() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.snapshot_list.select_row(<span class="va">self</span>.snapshot_list.get_row_at_index(idx))</span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> name_changed_event(<span class="va">self</span>, _):</span>
<span id="cb4-401"><a href="#cb4-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.group_id() <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-402"><a href="#cb4-402" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb4-403"><a href="#cb4-403" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> <span class="va">self</span>.name.get_text()</span>
<span id="cb4-404"><a href="#cb4-404" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iface.db.set_name(<span class="va">self</span>.group_id(), name)</span>
<span id="cb4-405"><a href="#cb4-405" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.group_info().name <span class="op">=</span> name</span>
<span id="cb4-406"><a href="#cb4-406" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.session_list.get_selected_row().get_child().set_label(name)</span>
<span id="cb4-407"><a href="#cb4-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-408"><a href="#cb4-408" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> description_changed_event(<span class="va">self</span>, <span class="bu">buffer</span>):</span>
<span id="cb4-409"><a href="#cb4-409" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> <span class="bu">buffer</span>.get_start_iter()</span>
<span id="cb4-410"><a href="#cb4-410" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> <span class="bu">buffer</span>.get_end_iter()</span>
<span id="cb4-411"><a href="#cb4-411" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iface.db.set_description(<span class="va">self</span>.group_id(), <span class="bu">buffer</span>.get_text(start, end, <span class="va">True</span>))</span>
<span id="cb4-412"><a href="#cb4-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-413"><a href="#cb4-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-414"><a href="#cb4-414" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> session_pane(iface):</span>
<span id="cb4-415"><a href="#cb4-415" aria-hidden="true" tabindex="-1"></a>    search_bar <span class="op">=</span> Gtk.SearchEntry()</span>
<span id="cb4-416"><a href="#cb4-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-417"><a href="#cb4-417" aria-hidden="true" tabindex="-1"></a>    session_overlay <span class="op">=</span> Gtk.Overlay()</span>
<span id="cb4-418"><a href="#cb4-418" aria-hidden="true" tabindex="-1"></a>    session_list <span class="op">=</span> Gtk.ListBox()</span>
<span id="cb4-419"><a href="#cb4-419" aria-hidden="true" tabindex="-1"></a>    list_box <span class="op">=</span> Gtk.Box.new(Gtk.Orientation.VERTICAL, <span class="dv">5</span>)</span>
<span id="cb4-420"><a href="#cb4-420" aria-hidden="true" tabindex="-1"></a>    list_box.append(session_list)</span>
<span id="cb4-421"><a href="#cb4-421" aria-hidden="true" tabindex="-1"></a>    list_box.append(list_box_label(<span class="st">&quot;&quot;</span>))</span>
<span id="cb4-422"><a href="#cb4-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># session_list.set_vexpand(True)</span></span>
<span id="cb4-423"><a href="#cb4-423" aria-hidden="true" tabindex="-1"></a>    scroll <span class="op">=</span> Gtk.ScrolledWindow()</span>
<span id="cb4-424"><a href="#cb4-424" aria-hidden="true" tabindex="-1"></a>    scroll.set_child(list_box)</span>
<span id="cb4-425"><a href="#cb4-425" aria-hidden="true" tabindex="-1"></a>    scroll.set_vexpand(<span class="va">True</span>)</span>
<span id="cb4-426"><a href="#cb4-426" aria-hidden="true" tabindex="-1"></a>    session_overlay.set_child(scroll)</span>
<span id="cb4-427"><a href="#cb4-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-428"><a href="#cb4-428" aria-hidden="true" tabindex="-1"></a>    ctrl <span class="op">=</span> Gtk.Box.new(Gtk.Orientation.VERTICAL, <span class="dv">0</span>)</span>
<span id="cb4-429"><a href="#cb4-429" aria-hidden="true" tabindex="-1"></a>    ctrl.append(search_bar)</span>
<span id="cb4-430"><a href="#cb4-430" aria-hidden="true" tabindex="-1"></a>    ctrl.append(session_overlay)</span>
<span id="cb4-431"><a href="#cb4-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-432"><a href="#cb4-432" aria-hidden="true" tabindex="-1"></a>    new_group_button <span class="op">=</span> icon_button(<span class="st">&quot;list-add-symbolic&quot;</span>)</span>
<span id="cb4-433"><a href="#cb4-433" aria-hidden="true" tabindex="-1"></a>    session_overlay.add_overlay(new_group_button)</span>
<span id="cb4-434"><a href="#cb4-434" aria-hidden="true" tabindex="-1"></a>    new_group_button.set_property(<span class="st">&quot;halign&quot;</span>, Gtk.Align.CENTER)</span>
<span id="cb4-435"><a href="#cb4-435" aria-hidden="true" tabindex="-1"></a>    new_group_button.set_property(<span class="st">&quot;valign&quot;</span>, Gtk.Align.END)</span>
<span id="cb4-436"><a href="#cb4-436" aria-hidden="true" tabindex="-1"></a>    new_group_button.set_margin_bottom(<span class="dv">5</span>)</span>
<span id="cb4-437"><a href="#cb4-437" aria-hidden="true" tabindex="-1"></a>    session_list.set_margin_bottom(new_group_button.get_height() <span class="op">+</span> <span class="dv">10</span>)</span>
<span id="cb4-438"><a href="#cb4-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-439"><a href="#cb4-439" aria-hidden="true" tabindex="-1"></a>    info <span class="op">=</span> Gtk.Box.new(Gtk.Orientation.VERTICAL, <span class="dv">5</span>)</span>
<span id="cb4-440"><a href="#cb4-440" aria-hidden="true" tabindex="-1"></a>    info.set_margin_start(<span class="dv">5</span>)</span>
<span id="cb4-441"><a href="#cb4-441" aria-hidden="true" tabindex="-1"></a>    info.set_margin_end(<span class="dv">5</span>)</span>
<span id="cb4-442"><a href="#cb4-442" aria-hidden="true" tabindex="-1"></a>    info.set_margin_top(<span class="dv">5</span>)</span>
<span id="cb4-443"><a href="#cb4-443" aria-hidden="true" tabindex="-1"></a>    info.set_margin_bottom(<span class="dv">5</span>)</span>
<span id="cb4-444"><a href="#cb4-444" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> Gtk.Entry()</span>
<span id="cb4-445"><a href="#cb4-445" aria-hidden="true" tabindex="-1"></a>    title.set_name(<span class="st">&quot;session-title&quot;</span>)</span>
<span id="cb4-446"><a href="#cb4-446" aria-hidden="true" tabindex="-1"></a>    title.set_has_frame(<span class="va">False</span>)</span>
<span id="cb4-447"><a href="#cb4-447" aria-hidden="true" tabindex="-1"></a>    info.append(title)</span>
<span id="cb4-448"><a href="#cb4-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-449"><a href="#cb4-449" aria-hidden="true" tabindex="-1"></a>    descr_frame <span class="op">=</span> Gtk.Frame()</span>
<span id="cb4-450"><a href="#cb4-450" aria-hidden="true" tabindex="-1"></a>    descr_frame.set_label(<span class="st">&quot;Description&quot;</span>)</span>
<span id="cb4-451"><a href="#cb4-451" aria-hidden="true" tabindex="-1"></a>    descr_scroll <span class="op">=</span> Gtk.ScrolledWindow()</span>
<span id="cb4-452"><a href="#cb4-452" aria-hidden="true" tabindex="-1"></a>    descr <span class="op">=</span> Gtk.TextView()</span>
<span id="cb4-453"><a href="#cb4-453" aria-hidden="true" tabindex="-1"></a>    descr.set_wrap_mode(Gtk.WrapMode.WORD)</span>
<span id="cb4-454"><a href="#cb4-454" aria-hidden="true" tabindex="-1"></a>    descr_scroll.set_child(descr)</span>
<span id="cb4-455"><a href="#cb4-455" aria-hidden="true" tabindex="-1"></a>    descr_scroll.set_size_request(<span class="op">-</span><span class="dv">1</span>, <span class="dv">100</span>)</span>
<span id="cb4-456"><a href="#cb4-456" aria-hidden="true" tabindex="-1"></a>    descr_frame.set_child(descr_scroll)</span>
<span id="cb4-457"><a href="#cb4-457" aria-hidden="true" tabindex="-1"></a>    info.append(descr_frame)</span>
<span id="cb4-458"><a href="#cb4-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-459"><a href="#cb4-459" aria-hidden="true" tabindex="-1"></a>    snaps_overlay <span class="op">=</span> Gtk.Overlay()</span>
<span id="cb4-460"><a href="#cb4-460" aria-hidden="true" tabindex="-1"></a>    new_snapshot_button <span class="op">=</span> icon_button(<span class="st">&quot;list-add-symbolic&quot;</span>)</span>
<span id="cb4-461"><a href="#cb4-461" aria-hidden="true" tabindex="-1"></a>    new_snapshot_button.set_property(<span class="st">&quot;halign&quot;</span>, Gtk.Align.CENTER)</span>
<span id="cb4-462"><a href="#cb4-462" aria-hidden="true" tabindex="-1"></a>    new_snapshot_button.set_property(<span class="st">&quot;valign&quot;</span>, Gtk.Align.END)</span>
<span id="cb4-463"><a href="#cb4-463" aria-hidden="true" tabindex="-1"></a>    new_snapshot_button.set_margin_bottom(<span class="dv">5</span>)</span>
<span id="cb4-464"><a href="#cb4-464" aria-hidden="true" tabindex="-1"></a>    snaps_frame <span class="op">=</span> Gtk.Frame()</span>
<span id="cb4-465"><a href="#cb4-465" aria-hidden="true" tabindex="-1"></a>    snaps_frame.set_label(<span class="st">&quot;Snapshots&quot;</span>)</span>
<span id="cb4-466"><a href="#cb4-466" aria-hidden="true" tabindex="-1"></a>    snaps_scroll <span class="op">=</span> Gtk.ScrolledWindow()</span>
<span id="cb4-467"><a href="#cb4-467" aria-hidden="true" tabindex="-1"></a>    snaps <span class="op">=</span> Gtk.ListBox()</span>
<span id="cb4-468"><a href="#cb4-468" aria-hidden="true" tabindex="-1"></a>    snaps_box <span class="op">=</span> Gtk.Box.new(Gtk.Orientation.VERTICAL, <span class="dv">0</span>)</span>
<span id="cb4-469"><a href="#cb4-469" aria-hidden="true" tabindex="-1"></a>    snaps_box.append(snaps)</span>
<span id="cb4-470"><a href="#cb4-470" aria-hidden="true" tabindex="-1"></a>    snaps_box.append(list_box_label(<span class="st">&quot;&quot;</span>))</span>
<span id="cb4-471"><a href="#cb4-471" aria-hidden="true" tabindex="-1"></a>    snaps_scroll.set_child(snaps_box)</span>
<span id="cb4-472"><a href="#cb4-472" aria-hidden="true" tabindex="-1"></a>    snaps_frame.set_child(snaps_overlay)</span>
<span id="cb4-473"><a href="#cb4-473" aria-hidden="true" tabindex="-1"></a>    snaps_frame.set_vexpand(<span class="va">True</span>)</span>
<span id="cb4-474"><a href="#cb4-474" aria-hidden="true" tabindex="-1"></a>    snaps_overlay.set_child(snaps_scroll)</span>
<span id="cb4-475"><a href="#cb4-475" aria-hidden="true" tabindex="-1"></a>    snaps_overlay.add_overlay(new_snapshot_button)</span>
<span id="cb4-476"><a href="#cb4-476" aria-hidden="true" tabindex="-1"></a>    info.append(snaps_frame)</span>
<span id="cb4-477"><a href="#cb4-477" aria-hidden="true" tabindex="-1"></a>    info.set_sensitive(<span class="va">False</span>)</span>
<span id="cb4-478"><a href="#cb4-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-479"><a href="#cb4-479" aria-hidden="true" tabindex="-1"></a>    vbox <span class="op">=</span> Gtk.Box.new(Gtk.Orientation.VERTICAL, <span class="dv">5</span>)</span>
<span id="cb4-480"><a href="#cb4-480" aria-hidden="true" tabindex="-1"></a>    vbox.append(ctrl)</span>
<span id="cb4-481"><a href="#cb4-481" aria-hidden="true" tabindex="-1"></a>    vbox.append(info)</span>
<span id="cb4-482"><a href="#cb4-482" aria-hidden="true" tabindex="-1"></a>    vbox.set_homogeneous(<span class="va">True</span>)</span>
<span id="cb4-483"><a href="#cb4-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-484"><a href="#cb4-484" aria-hidden="true" tabindex="-1"></a>    pane <span class="op">=</span> SessionPane(</span>
<span id="cb4-485"><a href="#cb4-485" aria-hidden="true" tabindex="-1"></a>        iface<span class="op">=</span>iface,</span>
<span id="cb4-486"><a href="#cb4-486" aria-hidden="true" tabindex="-1"></a>        search_entry<span class="op">=</span>search_bar,</span>
<span id="cb4-487"><a href="#cb4-487" aria-hidden="true" tabindex="-1"></a>        session_list<span class="op">=</span>session_list,</span>
<span id="cb4-488"><a href="#cb4-488" aria-hidden="true" tabindex="-1"></a>        add_session_button<span class="op">=</span>new_group_button,</span>
<span id="cb4-489"><a href="#cb4-489" aria-hidden="true" tabindex="-1"></a>        info_box<span class="op">=</span>info,</span>
<span id="cb4-490"><a href="#cb4-490" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>title,</span>
<span id="cb4-491"><a href="#cb4-491" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span>descr,</span>
<span id="cb4-492"><a href="#cb4-492" aria-hidden="true" tabindex="-1"></a>        snapshot_list<span class="op">=</span>snaps,</span>
<span id="cb4-493"><a href="#cb4-493" aria-hidden="true" tabindex="-1"></a>        add_snapshot_button<span class="op">=</span>new_snapshot_button)</span>
<span id="cb4-494"><a href="#cb4-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-495"><a href="#cb4-495" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vbox, pane</span>
<span id="cb4-496"><a href="#cb4-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-497"><a href="#cb4-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-498"><a href="#cb4-498" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_activate(app, iface):</span>
<span id="cb4-499"><a href="#cb4-499" aria-hidden="true" tabindex="-1"></a>    win <span class="op">=</span> Gtk.ApplicationWindow(application<span class="op">=</span>app, title<span class="op">=</span><span class="st">&quot;NymphesCC&quot;</span>)</span>
<span id="cb4-500"><a href="#cb4-500" aria-hidden="true" tabindex="-1"></a>    css_provider <span class="op">=</span> Gtk.CssProvider()</span>
<span id="cb4-501"><a href="#cb4-501" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> resources.path(__package__, <span class="st">&quot;gtk-style.css&quot;</span>) <span class="im">as</span> path:</span>
<span id="cb4-502"><a href="#cb4-502" aria-hidden="true" tabindex="-1"></a>        css_provider.load_from_path(<span class="bu">str</span>(path))</span>
<span id="cb4-503"><a href="#cb4-503" aria-hidden="true" tabindex="-1"></a>    win.get_style_context().add_provider_for_display(</span>
<span id="cb4-504"><a href="#cb4-504" aria-hidden="true" tabindex="-1"></a>        Gdk.Display.get_default(), css_provider, Gtk.STYLE_PROVIDER_PRIORITY_USER)</span>
<span id="cb4-505"><a href="#cb4-505" aria-hidden="true" tabindex="-1"></a>    win.set_default_size(<span class="dv">1600</span>, <span class="dv">1000</span>)</span>
<span id="cb4-506"><a href="#cb4-506" aria-hidden="true" tabindex="-1"></a>    header_bar <span class="op">=</span> Gtk.HeaderBar()</span>
<span id="cb4-507"><a href="#cb4-507" aria-hidden="true" tabindex="-1"></a>    header_bar.set_show_title_buttons(<span class="va">True</span>)</span>
<span id="cb4-508"><a href="#cb4-508" aria-hidden="true" tabindex="-1"></a>    side_bar_button <span class="op">=</span> Gtk.Button()</span>
<span id="cb4-509"><a href="#cb4-509" aria-hidden="true" tabindex="-1"></a>    win.set_titlebar(header_bar)</span>
<span id="cb4-510"><a href="#cb4-510" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> Gtk.Grid()</span>
<span id="cb4-511"><a href="#cb4-511" aria-hidden="true" tabindex="-1"></a>    grid.add_css_class(<span class="st">&quot;mod-baseline&quot;</span>)</span>
<span id="cb4-512"><a href="#cb4-512" aria-hidden="true" tabindex="-1"></a>    controls <span class="op">=</span> {}</span>
<span id="cb4-513"><a href="#cb4-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-514"><a href="#cb4-514" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_ui_value(ctrl, mod, value):</span>
<span id="cb4-515"><a href="#cb4-515" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mod <span class="op">!=</span> controls[<span class="st">&quot;modulators.selector&quot;</span>].get_selected_row().get_index():</span>
<span id="cb4-516"><a href="#cb4-516" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb4-517"><a href="#cb4-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ctrl <span class="kw">not</span> <span class="kw">in</span> controls:</span>
<span id="cb4-518"><a href="#cb4-518" aria-hidden="true" tabindex="-1"></a>            logging.warn(<span class="st">&quot;no widget to control </span><span class="sc">%s</span><span class="st">&quot;</span>, ctrl)</span>
<span id="cb4-519"><a href="#cb4-519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb4-520"><a href="#cb4-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-521"><a href="#cb4-521" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> controls[ctrl]:</span>
<span id="cb4-522"><a href="#cb4-522" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Gtk.Scale():</span>
<span id="cb4-523"><a href="#cb4-523" aria-hidden="true" tabindex="-1"></a>                controls[ctrl].set_value(value)</span>
<span id="cb4-524"><a href="#cb4-524" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Gtk.ComboBoxText():</span>
<span id="cb4-525"><a href="#cb4-525" aria-hidden="true" tabindex="-1"></a>                controls[ctrl].set_active(value)</span>
<span id="cb4-526"><a href="#cb4-526" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Gtk.ListBox():</span>
<span id="cb4-527"><a href="#cb4-527" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> controls[ctrl]</span>
<span id="cb4-528"><a href="#cb4-528" aria-hidden="true" tabindex="-1"></a>                w.select_row(w.get_row_at_index(value))</span>
<span id="cb4-529"><a href="#cb4-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-530"><a href="#cb4-530" aria-hidden="true" tabindex="-1"></a>    iface.set_ui_value <span class="op">=</span> set_ui_value</span>
<span id="cb4-531"><a href="#cb4-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-532"><a href="#cb4-532" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write_output_queue(ctrl, value):</span>
<span id="cb4-533"><a href="#cb4-533" aria-hidden="true" tabindex="-1"></a>        mod <span class="op">=</span> controls[<span class="st">&quot;modulators.selector&quot;</span>].get_selected_row().get_index()</span>
<span id="cb4-534"><a href="#cb4-534" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> iface.register.flat_config[ctrl].mod <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-535"><a href="#cb4-535" aria-hidden="true" tabindex="-1"></a>            mod <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-536"><a href="#cb4-536" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> iface.register.gui_msg(ctrl, mod, value):</span>
<span id="cb4-537"><a href="#cb4-537" aria-hidden="true" tabindex="-1"></a>            iface.q_out.put_nowait((ctrl, mod, value))</span>
<span id="cb4-538"><a href="#cb4-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-539"><a href="#cb4-539" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_changed(widget, <span class="op">*</span>args):</span>
<span id="cb4-540"><a href="#cb4-540" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> widget:</span>
<span id="cb4-541"><a href="#cb4-541" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Gtk.ComboBoxText():</span>
<span id="cb4-542"><a href="#cb4-542" aria-hidden="true" tabindex="-1"></a>                (ctrl,) <span class="op">=</span> args</span>
<span id="cb4-543"><a href="#cb4-543" aria-hidden="true" tabindex="-1"></a>                write_output_queue(ctrl, widget.get_active())</span>
<span id="cb4-544"><a href="#cb4-544" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Gtk.Scale():</span>
<span id="cb4-545"><a href="#cb4-545" aria-hidden="true" tabindex="-1"></a>                (ctrl,) <span class="op">=</span> args</span>
<span id="cb4-546"><a href="#cb4-546" aria-hidden="true" tabindex="-1"></a>                write_output_queue(ctrl, <span class="bu">int</span>(widget.get_value()))</span>
<span id="cb4-547"><a href="#cb4-547" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Gtk.ListBox():</span>
<span id="cb4-548"><a href="#cb4-548" aria-hidden="true" tabindex="-1"></a>                row, ctrl <span class="op">=</span> args</span>
<span id="cb4-549"><a href="#cb4-549" aria-hidden="true" tabindex="-1"></a>                write_output_queue(ctrl, row.get_index())</span>
<span id="cb4-550"><a href="#cb4-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-551"><a href="#cb4-551" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_mod_change(widget, row):</span>
<span id="cb4-552"><a href="#cb4-552" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> row.get_child().get_label().lower().replace(<span class="st">&quot; &quot;</span>, <span class="st">&quot;-&quot;</span>)</span>
<span id="cb4-553"><a href="#cb4-553" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> row.get_index()</span>
<span id="cb4-554"><a href="#cb4-554" aria-hidden="true" tabindex="-1"></a>        css_classes <span class="op">=</span> [re.sub(<span class="st">&quot;mod-.*&quot;</span>, <span class="ss">f&quot;mod-</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&quot;</span>, c)</span>
<span id="cb4-555"><a href="#cb4-555" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">for</span> c <span class="kw">in</span> grid.get_css_classes()]</span>
<span id="cb4-556"><a href="#cb4-556" aria-hidden="true" tabindex="-1"></a>        grid.set_css_classes(css_classes)</span>
<span id="cb4-557"><a href="#cb4-557" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, setting <span class="kw">in</span> iface.register.flat_config.items():</span>
<span id="cb4-558"><a href="#cb4-558" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> setting.mod <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-559"><a href="#cb4-559" aria-hidden="true" tabindex="-1"></a>                widget <span class="op">=</span> controls[name]</span>
<span id="cb4-560"><a href="#cb4-560" aria-hidden="true" tabindex="-1"></a>                <span class="cf">match</span> widget:</span>
<span id="cb4-561"><a href="#cb4-561" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">case</span> Gtk.Scale():</span>
<span id="cb4-562"><a href="#cb4-562" aria-hidden="true" tabindex="-1"></a>                        widget.set_value(iface.register.values[index][name])</span>
<span id="cb4-563"><a href="#cb4-563" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">case</span> Gtk.ComboBox():</span>
<span id="cb4-564"><a href="#cb4-564" aria-hidden="true" tabindex="-1"></a>                        widget.set_active(iface.register.values[index][name])</span>
<span id="cb4-565"><a href="#cb4-565" aria-hidden="true" tabindex="-1"></a>        iface.q_out.put_nowait((<span class="st">&quot;modulators.selector&quot;</span>, <span class="va">None</span>, row.get_index()))</span>
<span id="cb4-566"><a href="#cb4-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-567"><a href="#cb4-567" aria-hidden="true" tabindex="-1"></a>    settings <span class="op">=</span> read_settings()</span>
<span id="cb4-568"><a href="#cb4-568" aria-hidden="true" tabindex="-1"></a>    layout <span class="op">=</span> [(<span class="st">&quot;oscillator&quot;</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">1</span>), </span>
<span id="cb4-569"><a href="#cb4-569" aria-hidden="true" tabindex="-1"></a>              (<span class="st">&quot;filter&quot;</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>),</span>
<span id="cb4-570"><a href="#cb4-570" aria-hidden="true" tabindex="-1"></a>              (<span class="st">&quot;envelope.filter&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb4-571"><a href="#cb4-571" aria-hidden="true" tabindex="-1"></a>              (<span class="st">&quot;envelope.amplitude&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb4-572"><a href="#cb4-572" aria-hidden="true" tabindex="-1"></a>              (<span class="st">&quot;lfo.lfo-1&quot;</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb4-573"><a href="#cb4-573" aria-hidden="true" tabindex="-1"></a>              (<span class="st">&quot;lfo.lfo-2&quot;</span>, <span class="dv">6</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb4-574"><a href="#cb4-574" aria-hidden="true" tabindex="-1"></a>              (<span class="st">&quot;reverb&quot;</span>, <span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)]</span>
<span id="cb4-575"><a href="#cb4-575" aria-hidden="true" tabindex="-1"></a>    grid.set_column_spacing(<span class="dv">5</span>)</span>
<span id="cb4-576"><a href="#cb4-576" aria-hidden="true" tabindex="-1"></a>    grid.set_row_spacing(<span class="dv">5</span>)</span>
<span id="cb4-577"><a href="#cb4-577" aria-hidden="true" tabindex="-1"></a>    grid.set_column_homogeneous(<span class="va">True</span>)</span>
<span id="cb4-578"><a href="#cb4-578" aria-hidden="true" tabindex="-1"></a>    grid.set_row_homogeneous(<span class="va">True</span>)</span>
<span id="cb4-579"><a href="#cb4-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-580"><a href="#cb4-580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s, x, y, w, h <span class="kw">in</span> layout:</span>
<span id="cb4-581"><a href="#cb4-581" aria-hidden="true" tabindex="-1"></a>        frame, s_controls <span class="op">=</span> slider_group(settings[s], on_changed)</span>
<span id="cb4-582"><a href="#cb4-582" aria-hidden="true" tabindex="-1"></a>        grid.attach(frame, x, y, w, h)</span>
<span id="cb4-583"><a href="#cb4-583" aria-hidden="true" tabindex="-1"></a>        controls.update(s_controls)</span>
<span id="cb4-584"><a href="#cb4-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-585"><a href="#cb4-585" aria-hidden="true" tabindex="-1"></a>    mode_box, mode_controls <span class="op">=</span> mode_selector(settings)</span>
<span id="cb4-586"><a href="#cb4-586" aria-hidden="true" tabindex="-1"></a>    mode_controls[<span class="st">&quot;misc.mode&quot;</span>].<span class="ex">connect</span>(<span class="st">&quot;row-selected&quot;</span>, on_changed, <span class="st">&quot;misc.mode&quot;</span>)</span>
<span id="cb4-587"><a href="#cb4-587" aria-hidden="true" tabindex="-1"></a>    mode_controls[<span class="st">&quot;modulators.selector&quot;</span>].<span class="ex">connect</span>(<span class="st">&quot;row-selected&quot;</span>, on_mod_change)</span>
<span id="cb4-588"><a href="#cb4-588" aria-hidden="true" tabindex="-1"></a>    controls.update(mode_controls)</span>
<span id="cb4-589"><a href="#cb4-589" aria-hidden="true" tabindex="-1"></a>    grid.attach(mode_box, <span class="dv">8</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb4-590"><a href="#cb4-590" aria-hidden="true" tabindex="-1"></a>    grid.set_margin_top(<span class="dv">5</span>)</span>
<span id="cb4-591"><a href="#cb4-591" aria-hidden="true" tabindex="-1"></a>    grid.set_margin_bottom(<span class="dv">5</span>)</span>
<span id="cb4-592"><a href="#cb4-592" aria-hidden="true" tabindex="-1"></a>    grid.set_margin_start(<span class="dv">5</span>)</span>
<span id="cb4-593"><a href="#cb4-593" aria-hidden="true" tabindex="-1"></a>    grid.set_margin_end(<span class="dv">5</span>)</span>
<span id="cb4-594"><a href="#cb4-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-595"><a href="#cb4-595" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> mod, v <span class="kw">in</span> iface.register.values.items():</span>
<span id="cb4-596"><a href="#cb4-596" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ctrl, value <span class="kw">in</span> v.items():</span>
<span id="cb4-597"><a href="#cb4-597" aria-hidden="true" tabindex="-1"></a>            set_ui_value(ctrl, mod, value)</span>
<span id="cb4-598"><a href="#cb4-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-599"><a href="#cb4-599" aria-hidden="true" tabindex="-1"></a>    side, _ <span class="op">=</span> session_pane(iface)</span>
<span id="cb4-600"><a href="#cb4-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-601"><a href="#cb4-601" aria-hidden="true" tabindex="-1"></a>    scrolled_main <span class="op">=</span> Gtk.ScrolledWindow()</span>
<span id="cb4-602"><a href="#cb4-602" aria-hidden="true" tabindex="-1"></a>    scrolled_main.set_child(grid)</span>
<span id="cb4-603"><a href="#cb4-603" aria-hidden="true" tabindex="-1"></a>    paned <span class="op">=</span> Gtk.Paned.new(Gtk.Orientation.HORIZONTAL)</span>
<span id="cb4-604"><a href="#cb4-604" aria-hidden="true" tabindex="-1"></a>    paned.set_start_child(side)</span>
<span id="cb4-605"><a href="#cb4-605" aria-hidden="true" tabindex="-1"></a>    paned.set_end_child(scrolled_main)</span>
<span id="cb4-606"><a href="#cb4-606" aria-hidden="true" tabindex="-1"></a>    paned.set_position(<span class="dv">300</span>)</span>
<span id="cb4-607"><a href="#cb4-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-608"><a href="#cb4-608" aria-hidden="true" tabindex="-1"></a>    win.set_child(paned)</span>
<span id="cb4-609"><a href="#cb4-609" aria-hidden="true" tabindex="-1"></a>    win.present()</span>
<span id="cb4-610"><a href="#cb4-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-611"><a href="#cb4-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-612"><a href="#cb4-612" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spawn(iface: Interface):</span>
<span id="cb4-613"><a href="#cb4-613" aria-hidden="true" tabindex="-1"></a>    app <span class="op">=</span> Gtk.Application(application_id<span class="op">=</span><span class="st">&#39;org.nymphescc&#39;</span>)</span>
<span id="cb4-614"><a href="#cb4-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-615"><a href="#cb4-615" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stop_threads(_):</span>
<span id="cb4-616"><a href="#cb4-616" aria-hidden="true" tabindex="-1"></a>        iface.quit_event.<span class="bu">set</span>()</span>
<span id="cb4-617"><a href="#cb4-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-618"><a href="#cb4-618" aria-hidden="true" tabindex="-1"></a>    app.<span class="ex">connect</span>(<span class="st">&#39;activate&#39;</span>, on_activate, iface)</span>
<span id="cb4-619"><a href="#cb4-619" aria-hidden="true" tabindex="-1"></a>    app.<span class="ex">connect</span>(<span class="st">&#39;shutdown&#39;</span>, stop_threads)</span>
<span id="cb4-620"><a href="#cb4-620" aria-hidden="true" tabindex="-1"></a>    app.run(<span class="va">None</span>)</span>
<span id="cb4-621"><a href="#cb4-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-622"><a href="#cb4-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-623"><a href="#cb4-623" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb4-624"><a href="#cb4-624" aria-hidden="true" tabindex="-1"></a>    logging.getLogger().setLevel(logging.DEBUG)</span>
<span id="cb4-625"><a href="#cb4-625" aria-hidden="true" tabindex="-1"></a>    iface <span class="op">=</span> Interface()</span>
<span id="cb4-626"><a href="#cb4-626" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Thread(target=spawn, args=(iface,)).start()</span></span>
<span id="cb4-627"><a href="#cb4-627" aria-hidden="true" tabindex="-1"></a>    Thread(target<span class="op">=</span>iface.send_nymphes).start()</span>
<span id="cb4-628"><a href="#cb4-628" aria-hidden="true" tabindex="-1"></a>    Thread(target<span class="op">=</span>iface.read_nymphes).start()</span>
<span id="cb4-629"><a href="#cb4-629" aria-hidden="true" tabindex="-1"></a>    spawn(iface)</span></code></pre></div>
</div>
</section>
<section id="settings" class="level1 messages">
<h1 class="messages">Settings</h1>
<p>From the Nymphes manual we get a table with MIDI CC messages.</p>
<div class="named-code-block">
<p>«schema»</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Range</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span> { lower <span class="fu">:</span> <span class="dt">Natural</span>, upper <span class="fu">:</span> <span class="dt">Natural</span> }</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> range <span class="fu">=</span> \(lower <span class="fu">:</span> <span class="dt">Natural</span>) <span class="ot">-&gt;</span> \(upper <span class="fu">:</span> <span class="dt">Natural</span>) <span class="ot">-&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    { lower <span class="fu">=</span> lower, upper <span class="fu">=</span> upper }</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Tic</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span> { value <span class="fu">:</span> <span class="dt">Natural</span>, label <span class="fu">:</span> <span class="dt">Text</span> }</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> tic <span class="fu">=</span> \(value <span class="fu">:</span> <span class="dt">Natural</span>) <span class="ot">-&gt;</span> \(label <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    { value <span class="fu">=</span> value, label <span class="fu">=</span> label }</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Setting</span> <span class="fu">=</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">Type</span>    <span class="fu">=</span> { name <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                , long <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                , cc <span class="fu">:</span> <span class="dt">Natural</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                , bounds <span class="fu">:</span> <span class="dt">Range</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                , description <span class="fu">:</span> <span class="dt">Optional</span> <span class="dt">Text</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                , labels <span class="fu">:</span> <span class="dt">Optional</span> (<span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                , mod <span class="fu">:</span> <span class="dt">Optional</span> <span class="dt">Natural</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                , flags <span class="fu">:</span> <span class="dt">Optional</span> (<span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                , tics <span class="fu">:</span> <span class="dt">Optional</span> (<span class="dt">List</span> <span class="dt">Tic</span>) }</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    , default <span class="fu">=</span> { bounds <span class="fu">=</span> range <span class="dv">0</span> <span class="dv">127</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                , description <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Text</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                , labels <span class="fu">=</span> <span class="dt">None</span> (<span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                , mod <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Natural</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                , flags <span class="fu">=</span> <span class="dt">None</span> (<span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                , tics <span class="fu">=</span> <span class="dt">None</span> (<span class="dt">List</span> <span class="dt">Tic</span>) } }</span></code></pre></div>
</div>
<p><img src="messages.dhall" class="figure" alt="" /></p>
<section id="oscillator-control" class="level2 group" name="oscillator">
<h2 class="group" name="oscillator">Oscillator Control</h2>
<section id="wave-form" class="level3 setting" name="wave" data-cc="70"
data-mod="31">
<h3 class="setting" name="wave" data-cc="70" data-mod="31">Wave
form</h3>
<pre class="values"><code>{ tics = Some [tic 0 &quot;⩘&quot;, tic 63 &quot;⎍&quot;, tic 127 &quot;⋀&quot;] }</code></pre>
<p>Controls the shape of the generated wave, going from sawtooth through
square, to triangle waves.</p>
</section>
<section id="pulse-width" class="level3 setting" name="pw" data-cc="12"
data-mod="36">
<h3 class="setting" name="pw" data-cc="12" data-mod="36">Pulse
width</h3>
<p>Control the pulse width of the square wave form. This can be
modulated using LFO 2.</p>
</section>
<section id="level" class="level3 setting" name="lvl" data-cc="9"
data-mod="32">
<h3 class="setting" name="lvl" data-cc="9" data-mod="32">Level</h3>
<p>Sets the amplitude of the wave form.</p>
</section>
<section id="sub-oscillator" class="level3 setting" name="sub"
data-cc="10" data-mod="33">
<h3 class="setting" name="sub" data-cc="10"
data-mod="33">Sub-oscillator</h3>
<p>Amplitude of sub-oscillator, which produces a square wave one octave
below the main oscillator.</p>
</section>
<section id="noise-level" class="level3 setting" name="noise"
data-cc="11" data-mod="34">
<h3 class="setting" name="noise" data-cc="11" data-mod="34">Noise
level</h3>
<p>Amplitude of white noise, mixed in with main oscillator and
sub-oscillator.</p>
</section>
<section id="glide" class="level3 setting" name="gld" data-cc="5"
data-mod="37">
<h3 class="setting" name="gld" data-cc="5" data-mod="37">Glide</h3>
<pre class="values"><code>{ flags = Some [&quot;misc.legato&quot;] }</code></pre>
<p>Allow notes to glide (portamento). The behaviour strongly depends on
the playing mode. Optionally, glide will respond to legato playing.</p>
</section>
<section id="low-frequency-oscillator" class="level3 setting" name="lfo"
data-cc="13" data-mod="35">
<h3 class="setting" name="lfo" data-cc="13" data-mod="35">Low frequency
oscillator</h3>
<p>Control the change in pitch of the main oscillator with the LFO, from
subtle vibrato to extreme whoopy sounds.</p>
</section>
<section id="envelope-generator" class="level3 setting" name="eg"
data-cc="14" data-mod="41">
<h3 class="setting" name="eg" data-cc="14" data-mod="41">Envelope
Generator</h3>
<p>Control how much the filter envelope modulates the pitch of the
oscillator. Envelopes are unipolar.</p>
</section>
<section id="detune" class="level3 setting" name="dtn" data-cc="15"
data-mod="39">
<h3 class="setting" name="dtn" data-cc="15" data-mod="39">Detune</h3>
<p>Detune notes when in stacked modes (i.e. multiple oscillators per
node: UNI A, UNI B, TRI, DUO).</p>
</section>
<section id="chord-control" class="level3 setting" name="chord"
data-cc="16" data-mod="40">
<h3 class="setting" name="chord" data-cc="16" data-mod="40">Chord
control</h3>
<p>Choose from different predefined chords (see Chords tab).</p>
</section>
</section>
<section id="filter-control" class="level2 group" name="filter">
<h2 class="group" name="filter">Filter control</h2>
<section id="hipass-cutoff" class="level3 setting" name="hpf"
data-cc="81" data-mod="45">
<h3 class="setting" name="hpf" data-cc="81" data-mod="45">Hipass
Cutoff</h3>
<pre class="values"><code>{ tics = Some [tic 0 &quot;33 hZ&quot;, tic 63 &quot;&quot;, tic 127 &quot;17 khZ&quot;] }</code></pre>
<p>Sets the cutoff frequency of the hipass filter. Hipass is piped after
lopass, creating a bandpass.</p>
</section>
<section id="lopass-cutoff" class="level3 setting" name="cut"
data-cc="74" data-mod="42">
<h3 class="setting" name="cut" data-cc="74" data-mod="42">Lopass
Cutoff</h3>
<pre class="values"><code>{ tics = Some [tic 0 &quot;33 hZ&quot;, tic 63 &quot;&quot;, tic 127 &quot;17 khZ&quot;] }</code></pre>
<p>Sets the cutoff frequency of the lopass filter.</p>
</section>
<section id="resonance" class="level3 setting" name="res" data-cc="71"
data-mod="43">
<h3 class="setting" name="res" data-cc="71" data-mod="43">Resonance</h3>
<p>Sets the amount of filter resonance, i.e. how much upper frequencies
are amplified.</p>
</section>
<section id="tracking" class="level3 setting" name="track" data-cc="4"
data-mod="46">
<h3 class="setting" name="track" data-cc="4" data-mod="46">Tracking</h3>
<p>Sets how much the filter cutoff tracks the frequency of the main
oscillator. At <code>127</code> the cutoff frequncy tracks the
oscillator pitch 1:1. In combination with high resonance this can create
beautiful overtones.</p>
<p>If you set this to other fractions (e.g. <code>63</code> for quarter
tones), use only noise as a sound source, and beef up resonance, you can
play microtonal music!</p>
</section>
<section id="envelope-generator-1" class="level3 setting" name="eg"
data-cc="3" data-mod="44">
<h3 class="setting" name="eg" data-cc="3" data-mod="44">Envelope
generator</h3>
<p>Sets how much the filter envelope modulates the filter cutoff.</p>
</section>
<section id="low-frequency-oscillator-1" class="level3 setting"
name="lfo" data-cc="8" data-mod="47">
<h3 class="setting" name="lfo" data-cc="8" data-mod="47">Low frequency
oscillator</h3>
<p>Sets how much LFO 1 modulates the filter frequency cutoff.</p>
</section>
</section>
<section id="envelope" class="level2 group" name="envelope">
<h2 class="group" name="envelope">Envelope</h2>
<p>The envelopes follow classic Attack/Decay/Sustain/Release
pattern.</p>
<ul>
<li>Attack: time taken to reach maximum amplitude</li>
<li>Decay: time taken to reach sustain level</li>
<li>Sustain: relative amplitude of sustain level</li>
<li>Release: time taken after release to reach 0 amp.</li>
</ul>
<section id="filter-envelope" class="level3 group" name="filter">
<h3 class="group" name="filter">Filter Envelope</h3>
<section id="attack" class="level4 setting" name="a" data-cc="79"
data-mod="48">
<h4 class="setting" name="a" data-cc="79" data-mod="48">Attack</h4>
</section>
<section id="decay" class="level4 setting" name="d" data-cc="80"
data-mod="49">
<h4 class="setting" name="d" data-cc="80" data-mod="49">Decay</h4>
</section>
<section id="sustain" class="level4 setting" name="s" data-cc="82"
data-mod="50">
<h4 class="setting" name="s" data-cc="82" data-mod="50">Sustain</h4>
</section>
<section id="release" class="level4 setting" name="r" data-cc="83"
data-mod="51">
<h4 class="setting" name="r" data-cc="83" data-mod="51">Release</h4>
</section>
</section>
<section id="amplitude-envelope" class="level3 group" name="amplitude">
<h3 class="group" name="amplitude">Amplitude Envelope</h3>
<section id="attack-1" class="level4 setting" name="a" data-cc="73"
data-mod="52">
<h4 class="setting" name="a" data-cc="73" data-mod="52">Attack</h4>
</section>
<section id="decay-1" class="level4 setting" name="d" data-cc="84"
data-mod="53">
<h4 class="setting" name="d" data-cc="84" data-mod="53">Decay</h4>
</section>
<section id="sustain-1" class="level4 setting" name="s" data-cc="85"
data-mod="54">
<h4 class="setting" name="s" data-cc="85" data-mod="54">Sustain</h4>
</section>
<section id="release-1" class="level4 setting" name="r" data-cc="72"
data-mod="55">
<h4 class="setting" name="r" data-cc="72" data-mod="55">Release</h4>
</section>
</section>
</section>
<section id="lfo-control" class="level2 group" name="lfo">
<h2 class="group" name="lfo">LFO Control</h2>
<section id="lfo-1" class="level3 group" name="lfo-1">
<h3 class="group" name="lfo-1">LFO 1</h3>
<section id="type" class="level4 setting" name="type" data-cc="22">
<h4 class="setting" name="type" data-cc="22">Type</h4>
<pre class="values"><code>{ bounds = range 0 3, labels = Some [ &quot;BPM&quot;, &quot;LOW&quot;, &quot;HIGH&quot;, &quot;TRACK&quot; ] }</code></pre>
</section>
<section id="sync" class="level4 setting" name="sync" data-cc="23">
<h4 class="setting" name="sync" data-cc="23">Sync</h4>
<pre class="values"><code>{ bounds = range 0 1, labels = Some [ &quot;FREE&quot;, &quot;KEY SYNC&quot; ] }</code></pre>
</section>
<section id="rate" class="level4 setting" name="rate" data-cc="18"
data-mod="56">
<h4 class="setting" name="rate" data-cc="18" data-mod="56">Rate</h4>
</section>
<section id="wave" class="level4 setting" name="wave" data-cc="19"
data-mod="57">
<h4 class="setting" name="wave" data-cc="19" data-mod="57">Wave</h4>
</section>
<section id="delay" class="level4 setting" name="delay" data-cc="20"
data-mod="58">
<h4 class="setting" name="delay" data-cc="20" data-mod="58">Delay</h4>
</section>
<section id="fade" class="level4 setting" name="fade" data-cc="21"
data-mod="59">
<h4 class="setting" name="fade" data-cc="21" data-mod="59">Fade</h4>
</section>
</section>
<section id="lfo-2" class="level3 group" name="lfo-2">
<h3 class="group" name="lfo-2">LFO 2</h3>
<section id="type-1" class="level4 setting" name="type" data-cc="28">
<h4 class="setting" name="type" data-cc="28">Type</h4>
<pre class="values"><code>{ bounds = range 0 3, labels = Some [ &quot;BPM&quot;, &quot;LOW&quot;, &quot;HIGH&quot;, &quot;TRACK&quot; ] }</code></pre>
</section>
<section id="sync-1" class="level4 setting" name="sync" data-cc="29">
<h4 class="setting" name="sync" data-cc="29">Sync</h4>
<pre class="values"><code>{ bounds = range 0 1, labels = Some [ &quot;FREE&quot;, &quot;KEY SYNC&quot; ] }</code></pre>
</section>
<section id="rate-1" class="level4 setting" name="rate" data-cc="24"
data-mod="60">
<h4 class="setting" name="rate" data-cc="24" data-mod="60">Rate</h4>
</section>
<section id="wave-1" class="level4 setting" name="wave" data-cc="25"
data-mod="61">
<h4 class="setting" name="wave" data-cc="25" data-mod="61">Wave</h4>
</section>
<section id="delay-1" class="level4 setting" name="delay" data-cc="26"
data-mod="62">
<h4 class="setting" name="delay" data-cc="26" data-mod="62">Delay</h4>
</section>
<section id="fade-1" class="level4 setting" name="fade" data-cc="27"
data-mod="63">
<h4 class="setting" name="fade" data-cc="27" data-mod="63">Fade</h4>
</section>
</section>
</section>
<section id="reverb-control" class="level2 group" name="reverb">
<h2 class="group" name="reverb">Reverb Control</h2>
<section id="size" class="level3 setting" name="size" data-cc="75"
data-mod="65">
<h3 class="setting" name="size" data-cc="75" data-mod="65">Size</h3>
</section>
<section id="decay-2" class="level3 setting" name="decay" data-cc="76"
data-mod="66">
<h3 class="setting" name="decay" data-cc="76" data-mod="66">Decay</h3>
</section>
<section id="filter" class="level3 setting" name="filter" data-cc="77"
data-mod="67">
<h3 class="setting" name="filter" data-cc="77" data-mod="67">Filter</h3>
</section>
<section id="mix" class="level3 setting" name="mix" data-cc="78"
data-mod="69">
<h3 class="setting" name="mix" data-cc="78" data-mod="69">Mix</h3>
</section>
</section>
<section id="modulators" class="level2 group" name="modulators">
<h2 class="group" name="modulators">Modulators</h2>
<section id="selector" class="level3 setting" name="selector"
data-cc="30">
<h3 class="setting" name="selector" data-cc="30">Selector</h3>
<pre class="values"><code>{ bounds = range 0 3, labels = Some [&quot;LFO 2&quot;, &quot;Mod Wheel&quot;, &quot;Velocity&quot;, &quot;Aftertouch&quot;] }</code></pre>
</section>
</section>
<section id="misc" class="level2 group" name="misc">
<h2 class="group" name="misc">Misc</h2>
<section id="amp-level" class="level3 setting" name="amp" data-cc="7">
<h3 class="setting" name="amp" data-cc="7">Amp level</h3>
<p>Amplification, set to default 127.</p>
</section>
<section id="play-mode" class="level3 setting" name="mode" data-cc="17">
<h3 class="setting" name="mode" data-cc="17">Play mode</h3>
<pre class="values"><code>{ bounds = range 0 5, labels = Some [&quot;POLY&quot;, &quot;UNI A&quot;, &quot;UNI B&quot;, &quot;TRI&quot;, &quot;DUO&quot;, &quot;MONO&quot;] }</code></pre>
</section>
<section id="legato" class="level3 setting" name="legato" data-cc="68">
<h3 class="setting" name="legato" data-cc="68">Legato</h3>
<pre class="values"><code>{ bounds = range 0 1 }</code></pre>
</section>
</section>
</section>
<section id="patches-storage" class="level1">
<h1>Patches storage</h1>
<p>We store patches inside a SQLite3 database, encoded as raw Midi.</p>
<div class="named-code-block">
<p>file:nymphescc/db.py</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xdg <span class="im">import</span> xdg_config_home</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>db_schema <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="st">create table if not exists &quot;snapshots&quot;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="st">    ( &quot;id&quot; integer primary key autoincrement</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="st">    , &quot;group&quot; integer not null</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="st">       references &quot;groups&quot; (&quot;id&quot;) on delete cascade</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="st">    , &quot;date&quot; text default current_timestamp</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="st">    , &quot;midi&quot; blob not null</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="st">    , &quot;tags&quot; text );</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="st">create table if not exists &quot;groups&quot;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="st">    ( &quot;id&quot; integer primary key autoincrement</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="st">    , &quot;name&quot; text not null</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="st">    , &quot;description&quot; text );</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Snapshot:</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">int</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    timestamp: datetime</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    tags: Optional[<span class="bu">str</span>]</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    midi: <span class="bu">bytes</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GroupInfo:</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">int</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    description: Optional[<span class="bu">str</span>]</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NymphesDB:</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, path: Optional[Path] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> path <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> xdg_config_home() <span class="op">/</span> <span class="st">&quot;nymphescc&quot;</span> <span class="op">/</span> <span class="st">&quot;patches.db&quot;</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(path)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor <span class="op">=</span> <span class="va">self</span>._connection.cursor()</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor.executescript(db_schema)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.commit()</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new_group(<span class="va">self</span>, name: <span class="bu">str</span>, description: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a><span class="st">            insert into &quot;groups&quot; (&quot;name&quot;, &quot;description&quot;)</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="st">            values (?, ?)&quot;&quot;&quot;</span>, (name, description))</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.commit()</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._cursor.lastrowid</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new_snapshot(<span class="va">self</span>, group_id: <span class="bu">int</span>, midi: <span class="bu">bytes</span>, tags: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a><span class="st">            insert into &quot;snapshots&quot; (&quot;group&quot;, &quot;midi&quot;, &quot;tags&quot;)</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a><span class="st">            values (?, ?, ?)&quot;&quot;&quot;</span>, (group_id, midi, tags))</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.commit()</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._cursor.lastrowid</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> delete_group(<span class="va">self</span>, group_id: <span class="bu">int</span>):</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a><span class="st">            delete from &quot;groups&quot; where &quot;id&quot; = ?&quot;&quot;&quot;</span>, (group_id,))</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.commit()</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> group_info(<span class="va">self</span>, group_id: <span class="bu">int</span>) <span class="op">-&gt;</span> GroupInfo:</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>        info <span class="op">=</span> <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a><span class="st">            select &quot;id&quot;, &quot;name&quot;, &quot;description&quot; from &quot;groups&quot;</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a><span class="st">            where &quot;id&quot; is ?&quot;&quot;&quot;</span>, (group_id,))</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> GroupInfo(<span class="op">*</span>info.fetchone())</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> snapshots(<span class="va">self</span>, group_id: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[Snapshot]:</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>        members <span class="op">=</span> <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a><span class="st">            select &quot;id&quot;, &quot;date&quot;, &quot;midi&quot;, &quot;tags&quot; from &quot;snapshots&quot;</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="st">            where &quot;group&quot; is ?&quot;&quot;&quot;</span>, (group_id,))</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [Snapshot(key, datetime.fromisoformat(date), tags, midi)</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> key, date, midi, tags <span class="kw">in</span> members.fetchall()]</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_name(<span class="va">self</span>, group_id, name):</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a><span class="st">            update &quot;groups&quot; set &quot;name&quot; = ?</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="st">            where &quot;id&quot; = ?&quot;&quot;&quot;</span>, (name, group_id))</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.commit()</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_description(<span class="va">self</span>, group_id, name):</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a><span class="st">            update &quot;groups&quot; set &quot;description&quot; = ?</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a><span class="st">            where &quot;id&quot; = ?&quot;&quot;&quot;</span>, (name, group_id))</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.commit()</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> groups(<span class="va">self</span>):</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>        groups <span class="op">=</span> <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a><span class="st">            select * from &quot;groups&quot;</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span>)</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [GroupInfo(<span class="op">*</span>g) <span class="cf">for</span> g <span class="kw">in</span> groups.fetchall()]</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> snapshot(<span class="va">self</span>, snap_id: <span class="bu">int</span>) <span class="op">-&gt;</span> Snapshot:</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>        key, date, midi, tags <span class="op">=</span> <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="st">            select &quot;id&quot;, &quot;date&quot;, &quot;midi&quot;, &quot;tags&quot; from &quot;snapshots&quot;</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a><span class="st">            where &quot;id&quot; is ?&quot;&quot;&quot;</span>, (snap_id,)).fetchone()</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Snapshot(key, datetime.fromisoformat(date), tags, midi)</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tree(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">tuple</span>[GroupInfo, <span class="bu">list</span>[Snapshot]]]:</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>        groups <span class="op">=</span> <span class="va">self</span>._cursor.execute(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a><span class="st">            select * from &quot;groups&quot;</span></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span>).fetchall()</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [(GroupInfo(key, name, description), <span class="va">self</span>.snapshots(key))</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> key, name, description <span class="kw">in</span> groups]</span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> close(<span class="va">self</span>):</span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._connection.close()</span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_db(tmp_path: Path):</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> datetime <span class="im">import</span> timedelta, datetime</span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>    db <span class="op">=</span> NymphesDB(tmp_path <span class="op">/</span> <span class="st">&quot;test.db&quot;</span>)</span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>    group_id <span class="op">=</span> db.new_group(<span class="st">&quot;hello&quot;</span>, <span class="st">&quot;test 123&quot;</span>)</span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">isinstance</span>(group_id, <span class="bu">int</span>)</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>    snap_id <span class="op">=</span> db.new_snapshot(group_id, <span class="st">b&quot;123&quot;</span>)</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">isinstance</span>(snap_id, <span class="bu">int</span>)</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> db.snapshot(snap_id)</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> s.midi <span class="op">==</span> <span class="st">b&quot;123&quot;</span></span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> datetime.utcnow() <span class="op">-</span> s.timestamp <span class="op">&lt;</span> timedelta(seconds<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> db.tree()</span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> t[<span class="dv">0</span>][<span class="dv">0</span>].name <span class="op">==</span> <span class="st">&quot;hello&quot;</span></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(t[<span class="dv">0</span>][<span class="dv">1</span>]) <span class="op">==</span> <span class="dv">1</span></span></code></pre></div>
</div>
</section>
<section id="old-stuff" class="level1">
<h1>Old stuff</h1>
<p>Tried first with WxPython, but that library suffers from lack of
documentation and ugly looking results (compared to the slickness of
Gtk).</p>
<div class="named-code-block">
<p>file:nymphescc/wx.py</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> wx</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .messages <span class="im">import</span> Setting, Group, read_settings</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SettingSlider(wx.BoxSizer):</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, parent: Controller, setting: Setting):</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        wx.BoxSizer.<span class="fu">__init__</span>(<span class="va">self</span>, wx.VERTICAL)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> wx.StaticText(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>            parent,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>setting.name.upper(),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            size<span class="op">=</span>(<span class="dv">50</span>, <span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span>wx.ALIGN_CENTRE <span class="op">|</span> wx.TEXT_ALIGNMENT_CENTER)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        slider <span class="op">=</span> wx.Slider(</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            parent,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>            minValue<span class="op">=</span>setting.bounds.lower,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>            maxValue<span class="op">=</span>setting.bounds.upper,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>            value<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span>wx.SL_VERTICAL <span class="op">|</span> wx.SL_VALUE_LABEL <span class="op">|</span> wx.SL_INVERSE,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>setting.name,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>            size<span class="op">=</span>wx.Size(<span class="op">-</span><span class="dv">1</span>, <span class="dv">300</span>))</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> setting.description <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            label.SetHelpText(setting.description)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            slider.SetHelpText(setting.description)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Add(slider, wx.EXPAND)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        box <span class="op">=</span> wx.BoxSizer()</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        box.AddSpacer(<span class="dv">10</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        box.Add(label, wx.EXPAND)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Add(box, wx.ALIGN_CENTER_HORIZONTAL)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SettingsGroup(wx.StaticBoxSizer):</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, parent: wx.Window, name: <span class="bu">str</span>, group: Group):</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        wx.StaticBoxSizer.<span class="fu">__init__</span>(<span class="va">self</span>, wx.HORIZONTAL, parent, name)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> setting <span class="kw">in</span> group.content:</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> setting.bounds.upper <span class="op">!=</span> <span class="dv">127</span>:</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>            slider <span class="op">=</span> SettingSlider(parent, setting)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.Add(slider, wx.EXPAND)</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Controller(wx.Frame):</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, settings: <span class="bu">dict</span>[<span class="bu">str</span>, Group]):</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        wx.Frame.<span class="fu">__init__</span>(<span class="va">self</span>, <span class="va">None</span>, title<span class="op">=</span><span class="st">&quot;NymphesCC&quot;</span>, size<span class="op">=</span>(<span class="dv">800</span>,<span class="dv">600</span>))</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.CreateStatusBar()</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        vertical_stack <span class="op">=</span> wx.BoxSizer(wx.VERTICAL)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        horiz1 <span class="op">=</span> wx.BoxSizer()</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>        horiz2 <span class="op">=</span> wx.BoxSizer()</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        groups1 <span class="op">=</span> [<span class="st">&quot;oscillator&quot;</span>, <span class="st">&quot;filter&quot;</span>]</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>        groups2 <span class="op">=</span> [<span class="st">&quot;envelope.filter&quot;</span>, <span class="st">&quot;envelope.amplitude&quot;</span>, <span class="st">&quot;lfo.lfo-1&quot;</span>, <span class="st">&quot;lfo.lfo-2&quot;</span>]</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> select <span class="kw">in</span> groups1:</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>            horiz1.AddSpacer(<span class="dv">5</span>)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>            horiz1.Add(SettingsGroup(<span class="va">self</span>, select, settings[select]))</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>            horiz1.AddSpacer(<span class="dv">5</span>)</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> select <span class="kw">in</span> groups2:</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>            horiz2.AddSpacer(<span class="dv">5</span>)</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>            horiz2.Add(SettingsGroup(<span class="va">self</span>, select, settings[select]))</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>            horiz2.AddSpacer(<span class="dv">5</span>)</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>        vertical_stack.Add(horiz1)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>        vertical_stack.Add(horiz2)</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.SetSizer(vertical_stack) </span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Show(<span class="va">True</span>)</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    app <span class="op">=</span> wx.App(<span class="va">False</span>)</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    settings <span class="op">=</span> read_settings()</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> Controller(settings)</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    app.MainLoop()</span></code></pre></div>
</div>
</section>
        </div>
         <div class="col-3 col-s-3 menu" id="menu">
                <nav id="TOC" role="doc-toc">
                                <ul>
                                <li><a href="#core-data-model">Core data
                                model</a></li>
                                <li><a href="#gui">GUI</a></li>
                                <li><a
                                href="#settings">Settings</a></li>
                                <li><a href="#patches-storage">Patches
                                storage</a></li>
                                <li><a href="#old-stuff">Old
                                stuff</a></li>
                                </ul>
                </nav>
        </div> 
</div>
<div class="footer">
</div>
</body>
<!-- This script scrolls the page to top when a link in the TOC is clicked. -->
<script>
   var elems = document.getElementById("TOC").querySelectorAll("a");
   for (var i = 0; i < elems.length; ++i) {
      elems[i].addEventListener("click", clickFunc);
   }
   function clickFunc(e) {
      e.preventDefault();
      window.location.hash = this.hash;
      window.scrollTo(0, 0); 
   }
</script>
   <!-- Set the default landing page. Sections are set display: none by default
        except for the one that is currently the location hash. -->
   <script type="text/javascript">
           if (document.location.hash == "" || document.location.hash == "#") {
                document.location.hash = "#";
                window.scrollTo(0, 0); 
           }
  </script>
</html>
